<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Ma'lumotlarni bazaga yuklash</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { background: white; padding: 25px; border-radius: 8px; width: 400px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; margin-bottom: 20px; }
        label { display: block; margin-top: 12px; }
        select, input[type="date"], button { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 5px; }
        button { background: #00c853; color: white; font-weight: bold; border: none; cursor: pointer; margin-top: 20px; }
        button:hover { background: #009624; }
        #message { margin-top: 15px; text-align: center; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Ma'lumotlarni bazaga yuklash</h2>
        <form id="dataForm" method="POST">
            {% csrf_token %}
            <label for="stationSelect">Stansiyani tanlang:</label>
            <select id="stationSelect" name="station">
                <option value="all">Hammasi</option>
            </select>
            <label for="wellSelect">Quduqni tanlang:</label>
            <select id="wellSelect" name="well" disabled></select>
            <label for="start_date">Boshlang‘ich sana (YYYY-MM-DD):</label>
            <input type="date" id="start_date" name="start_date" required min="2020-01-01" max="2030-12-31" data-quillbot-exclude="true" data-gramm="false">
            <label for="end_date">Yakuniy sana (YYYY-MM-DD):</label>
            <input type="date" id="end_date" name="end_date" required min="2020-01-01" max="2030-12-31" data-quillbot-exclude="true" data-gramm="false">
            <button type="submit">Yuklash</button>
        </form>
        <div id="message"></div>
    </div>
    {{ stations|json_script:"stations_data" }}
    <script>
    const stationSelect = document.getElementById('stationSelect');
    const wellSelect = document.getElementById('wellSelect');
    const dataForm = document.getElementById('dataForm');
    const messageDiv = document.getElementById('message');

    const stationsDataElem = document.getElementById('stations_data');
    let stations = {};
    if (stationsDataElem) {
        try {
            stations = JSON.parse(stationsDataElem.textContent);
        } catch (e) {
            console.error('JSON parse error:', e, stationsDataElem.textContent);
            stations = {};
        }
    } else {
        console.error('stations_data elementi topilmadi!');
        stations = {};
    }

    function populateStations() {
        const defaultOption = document.createElement('option');
        defaultOption.value = 'all';
        defaultOption.textContent = 'Hammasi';
        stationSelect.appendChild(defaultOption);

        Object.keys(stations).forEach(stationCode => {
            const option = document.createElement('option');
            option.value = stationCode;
            option.textContent = stations[stationCode]?.name || stationCode;
            stationSelect.appendChild(option);
        });
    }

    function updateWellSelect() {
        const selectedStationCode = stationSelect.value;
        wellSelect.innerHTML = '';
        wellSelect.disabled = false;

        if (selectedStationCode === 'all') {
            const allWellsOption = document.createElement('option');
            allWellsOption.value = 'all_wells';
            allWellsOption.textContent = 'Hammasi';
            wellSelect.appendChild(allWellsOption);
        } else {
            const stationInfo = stations[selectedStationCode];
            if (stationInfo && stationInfo.wells) {
                const allWellsOption = document.createElement('option');
                allWellsOption.value = 'all_wells';
                allWellsOption.textContent = 'Hammasi';
                wellSelect.appendChild(allWellsOption);

                stationInfo.wells.forEach(well => {
                    const option = document.createElement('option');
                    option.value = well.api_well;
                    option.textContent = well.db_well;
                    wellSelect.appendChild(option);
                });
            } else {
                wellSelect.disabled = true;
            }
        }
    }

    if (Object.keys(stations).length === 0) {
        messageDiv.textContent = "Stansiyalar ma'lumoti mavjud emas!";
        messageDiv.className = 'error';
        dataForm.querySelector('button[type="submit"]').disabled = true;
    } else {
        populateStations();
        updateWellSelect();
    }

    stationSelect.addEventListener('change', updateWellSelect);

    // Prevent Quillbot and similar extensions from interfering with date inputs
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.addEventListener('focus', (event) => {
            event.stopPropagation();
        });
    });

    dataForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        const startDateInput = document.getElementById('start_date').value;
        const endDateInput = document.getElementById('end_date').value;

        if (!startDateInput || !endDateInput) {
            messageDiv.textContent = 'Iltimos, boshlang‘ich va yakuniy sanalarni kiriting!';
            messageDiv.className = 'error';
            return;
        }

        const startDate = new Date(startDateInput);
        const endDate = new Date(endDateInput);

        if (isNaN(startDate) || isNaN(endDate)) {
            messageDiv.textContent = 'Noto‘g‘ri sana formati!';
            messageDiv.className = 'error';
            return;
        }

        if (endDate < startDate) {
            messageDiv.textContent = 'Yakuniy sana boshlang‘ich sanadan keyin bo‘lishi kerak!';
            messageDiv.className = 'error';
            return;
        }

        messageDiv.textContent = 'Yuklanmoqda...';
        messageDiv.className = '';

        const formData = new FormData(dataForm);
        const csrfToken = formData.get('csrfmiddlewaretoken');

        // Ma'lumotlarni JSON formatiga o'tkazish
        const requestData = {
            station: formData.get('station'),
            well: formData.get('well'),
            start_date: formData.get('start_date'),
            end_date: formData.get('end_date'),
        };

        console.log('Form data:', requestData);
        
        try {
            console.log('Sending request to:', '/upload/');
            const response = await fetch('/upload/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', // Bu eng muhim o'zgarish
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify(requestData) // Ma'lumotlarni JSON satriga aylantirish
            });
            console.log('Response status:', response.status);

            if (!response.ok) {
                // HTTP xatolarini ushlash
                const responseText = await response.text();
                console.log('Server javobi:', responseText);
                throw new Error(`HTTP xatosi! Status: ${response.status}, Server javobi: ${responseText}`);
            }

            const result = await response.json();
            console.log('Response JSON:', result);

            if (result.success) {
                messageDiv.textContent = result.message;
                messageDiv.className = 'success';
            } else {
                messageDiv.textContent = result.message;
                messageDiv.className = 'error';
            }
        } catch (error) {
            console.error('An unexpected error occurred:', error);
            messageDiv.textContent = 'Xatolik yuz berdi: ' + error.message;
            messageDiv.className = 'error';
        }
        console.log('Final messageDiv content:', messageDiv.textContent);
    });
</script>
</body>
</html>